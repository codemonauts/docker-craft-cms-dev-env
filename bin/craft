#! /usr/bin/env bash

MYSQL_CONTAINER="mysql:5.6"
CRAFT_CONTAINER="codemonauts/craft-cms-dev-env"

function should_pull {
    if [ -z "$(docker images -q "$1" )" ]; then
        # image not available
        echo "Image for $1 is not available"
        return 0
    elif [ -z "$(docker images "$1" | grep hour)" ]; then
        echo "Image for $1 seems to be older than 2 days"
        # image is only a few hours old
        return 0
    else
        return 1
    fi
}


case "$1" in

  'start')
    mkdir -p ${HOME}/databases
    mkdir -p ${HOME}/database_config
    if should_pull "$MYSQL_CONTAINER"; then
        echo "Pulling new MySQL container..."
        docker pull "$MYSQL_CONTAINER" > /dev/null
    fi
    docker run --rm -d --name mysql -p 3306:3306 -v "${HOME}/databases:/var/lib/mysql" -v "${HOME}/database_config:/etc/mysql/conf.d" -e MYSQL_ROOT_PASSWORD=root "$MYSQL_CONTAINER"
    if [ $? == 0 ]; then
      if should_pull "$CRAFT_CONTAINER"; then
          echo "Pulling new craft container..."
          docker pull "$CRAFT_CONTAINER" > /dev/null
      fi
      PHPVERSION=$2
      if [ -z $PHPVERSION ]; then
          PHPVERSION="7.0"
      fi 
      docker run --rm -d --name craft -p 8080:80 -v "${PWD}:/local" -e "PHPVERSION=$PHPVERSION" --link mysql:mysql "$CRAFT_CONTAINER"
      if [ $? == 0 ]; then
        echo "Started Craft CMS environment in ${PWD} and databases stored to ${HOME}/databases."
      else
        echo "Error starting webserver container. See error messages above!"
      fi
    else
      echo "Error starting MySQL container. See error messages above!"
    fi
    ;;

  'stop')
    docker stop craft
    docker exec mysql /etc/init.d/mysql stop
    docker stop mysql
    ;;

  'restart')
    $0 stop
    $0 start
    ;;

  'yiic')
    echo "${@:2}"
    docker exec craft /bin/bash -c "/local/craft/app/etc/console/yiic ${@:2}"
    ;; 

  'shell')
    docker exec -it craft /bin/bash
    ;; 

  'create')
    docker exec craft /bin/bash -c "mysqladmin create ${2}"
    ;;

  'drop')
    docker exec -it craft /bin/bash -c "mysqladmin drop ${2}"
    ;;

  'import')
    docker exec -it craft /bin/bash -c "extract.sh ${2} ${3}"
    ;;

  'compile')
    docker exec -it craft /bin/bash -c "compile.sh"
    docker exec -it craft /bin/bash -c "watch.sh"
    ;;

  'gulp')
    docker exec -it craft /bin/bash -c "gulp.sh"
    ;;

  'tunnel')
    docker exec -it craft /bin/bash -c "ngrok http 80"
    ;;

esac
